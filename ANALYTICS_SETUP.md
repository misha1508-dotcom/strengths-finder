# Настройка аналитики для проекта Inversion

Эта система аналитики отслеживает поведение пользователей и отправляет уведомления в Telegram.

## Что отслеживается

### События пользователя:
1. **page_view** - зашёл на сайт
2. **situation_started** - начал выписывать ситуации
3. **situation_saved** - сохранил ситуацию (с данными о длине и индексе)
4. **analysis_started** - нажал "Перейти к анализу"
5. **analysis_completed** - анализ завершён
6. **feathers_clicked** - нажал на "Узнать пёрышки"
7. **activities_clicked** - загрузились активности
8. **copy_clicked** - нажал "Скопировать данные"
9. **telegram_clicked** - нажал на ссылку Telegram

### Метрики:
- Уникальные посетители
- Воронка конверсии по этапам
- Медианное количество ситуаций на пользователя
- Медианная длина ситуации в символах

## Настройка

### 1. Создание Telegram-бота

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям (выберите имя и username для бота)
4. Сохраните токен, который вам выдаст BotFather

### 2. Получение Chat ID

1. Отправьте вашему новому боту любое сообщение (например, "привет")
2. Откройте в браузере:
   ```
   https://api.telegram.org/bot<ВАШ_ТОКЕН>/getUpdates
   ```
3. Найдите в ответе поле `"chat":{"id":123456789}` - это ваш Chat ID

### 3. Генерация секретного ключа для аналитики

Выполните в терминале:
```bash
openssl rand -base64 32
```

### 4. Настройка переменных окружения

Создайте файл `.env.local` в корне проекта:

```env
# Существующие ключи
ANTHROPIC_API_KEY=your_api_key_here
OPENROUTER_API_KEY=your_openrouter_api_key_here

# Новые переменные для аналитики
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_CHAT_ID=123456789
ANALYTICS_SECRET_KEY=ваш_сгенерированный_ключ_из_шага_3
```

### 5. Установка зависимостей для Telegram-бота

```bash
cd inversion
npm install node-telegram-bot-api
```

### 6. Запуск бота

В отдельном терминале:
```bash
node telegram-bot.js
```

## Использование

### Команды Telegram-бота:

- `/start` - запустить бота и увидеть список команд
- `/stats` - общая статистика (уники, сессии, медианы)
- `/funnel` - воронка конверсии по этапам
- `/sessions` - последние 10 сессий

### Автоматические уведомления:

Бот автоматически отправит вам уведомление когда:
- Кто-то завершил анализ ситуаций (событие `analysis_completed`)

Уведомление содержит:
- Количество выписанных ситуаций
- Session ID для идентификации
- Время события

### Просмотр статистики через API:

Вы можете получить полную статистику через HTTP запрос:

```bash
curl "http://localhost:3000/api/analytics?key=ваш_секретный_ключ"
```

Или для production:
```bash
curl "https://ваш-домен.vercel.app/api/analytics?key=ваш_секретный_ключ"
```

## Структура данных

### Файл analytics-data.json

Данные хранятся локально в файле `analytics-data.json` в корне проекта:

```json
{
  "sessions": {
    "session_123_abc": {
      "sessionId": "session_123_abc",
      "startTime": 1234567890000,
      "events": [...],
      "situations": {
        "count": 3,
        "lengths": [120, 200, 150]
      },
      "completedAnalysis": true
    }
  },
  "lastUpdated": 1234567890000
}
```

### Формат события:

```typescript
{
  eventType: 'situation_saved',
  timestamp: 1234567890000,
  sessionId: 'session_123_abc',
  data: {
    situationIndex: 0,
    situationLength: 120,
    situationsCount: 1
  }
}
```

## Отслеживаемые метрики

### Воронка конверсии:

1. **Зашли на сайт** → page_view
2. **Начали писать** → situation_started
   _Конверсия: начали / зашли_
3. **Сохранили ситуацию** → situation_saved
   _Конверсия: сохранили / начали_
4. **Отправили на анализ** → analysis_completed
   _Конверсия: отправили / сохранили_
5. **Нажали на пёрышки** → feathers_clicked
   _Конверсия: пёрышки / анализ_
6. **Скопировали данные** → copy_clicked
   _Конверсия: скопировали / пёрышки_
7. **Перешли в Telegram** → telegram_clicked

### Медианные значения:

- **Медиана ситуаций на пользователя** - сколько в среднем ситуаций выписывает один пользователь
- **Медиана длины ситуации** - средняя длина одной ситуации в символах

## Production

Для production на Vercel:

1. Добавьте переменные окружения в настройках проекта Vercel:
   - `TELEGRAM_BOT_TOKEN`
   - `TELEGRAM_CHAT_ID`
   - `ANALYTICS_SECRET_KEY`

2. Telegram-бот должен быть запущен на отдельном сервере (не на Vercel)

3. В переменных окружения бота укажите production URL:
   ```env
   ANALYTICS_URL=https://ваш-проект.vercel.app/api/analytics
   ```

## Безопасность

- Никогда не коммитьте `.env.local` в git
- Держите `ANALYTICS_SECRET_KEY` в секрете
- Используйте HTTPS для production API
- Файл `analytics-data.json` добавлен в `.gitignore`

## Troubleshooting

### Бот не получает обновления
- Проверьте правильность `TELEGRAM_BOT_TOKEN`
- Убедитесь что вы отправили боту хотя бы одно сообщение

### Не приходят уведомления
- Проверьте `TELEGRAM_CHAT_ID`
- Проверьте логи сервера на ошибки
- Убедитесь что переменные окружения установлены

### Статистика не сохраняется
- Проверьте права на запись в директорию проекта
- Убедитесь что `analytics-data.json` не открыт в другой программе

### Ошибка 401 при запросе статистики
- Проверьте правильность `ANALYTICS_SECRET_KEY`
- Убедитесь что ключ передаётся в URL параметре `?key=`
